---
Description: ""
AWSTemplateFormatVersion: "2010-09-09"
Parameters:
  ASI:
    Type: String
    MinLength: 2
    MaxLength: 5
    Description: "asi - must be lower-case, limit 4 characters"
    AllowedPattern: "[a-z]*"
  Environment:
    Type: String
    MinLength: 3
    MaxLength: 7
    Description: "environment (nonprod|dev|itg|cat|prod) - must be lower-case, limit 7 characters"
    AllowedPattern: "[a-z]*"
  Owner:
    Type: String
    Description: "email address of the the Owner of this stack"
    Default: "phillips.james@gmail.com"
    AllowedPattern: "^[\\w-\\+]+(\\.[\\w]+)*@[\\w-]+(\\.[\\w]+)*(\\.[a-z]{2,})$"
  BusinessOwnerContact:
    Type: String
    Description: "Contact address of the the Business Owner of this trading relationship"
    Default: "phillips.james@gmail.com"
    AllowedPattern: "^[\\w-\\+]+(\\.[\\w]+)*@[\\w-]+(\\.[\\w]+)*(\\.[a-z]{2,})$"
  RemoteOrganizationContact:
    Type: String
    Description: "Contact address of the the Remote User"
    Default: "phillips.james@gmail.com"
    AllowedPattern: "^[\\w-\\+]+(\\.[\\w]+)*@[\\w-]+(\\.[\\w]+)*(\\.[a-z]{2,})$"
  UserName:
    Type: String
    MinLength: 5
    MaxLength: 24
    Description: "Account User Name - must be lower-case, 5-24 characters only alpha"
    AllowedPattern: "[a-z]*"
  SshPublicKey:
    Type: String
  ServerId:
    Type: String
    AllowedPattern: '^s-([0-9a-f]{17})$'
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - 
      Label:
        default: "Environment Configuration"
      Parameters:
        - ASI
        - Environment
        - Owner
    -
      Label: 
        default: "Account Configuration"
      Parameters:
        - UserName
        - BusinessOwnerContact
        - RemoteOrganizationContact
        - ServerId
        - SshPublicKey

Resources:
  SftpBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Join
      - '-'
      - - !Ref ASI
        - !Ref Environment
        - !Ref 'AWS::Region'
        - 'sftp-bucket'
      AccessControl: Private
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      Tags:
        -
          Key: "Owner"
          Value: !Ref Owner
  SftpBucketRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - transfer.amazonaws.com
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: sftp-s3-bucket-access-policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - 's3:ListBucket'
                  - 's3:GetBucketLocation'
                Resource: !Join
                  - ''
                  - -  'arn:aws:s3:::'
                    -  !Ref SftpBucket
              - Effect: Allow
                Action:
                  - 's3:PutObject'
                  - 's3:GetObject'
                  - 's3:DeleteObject'
                  - 's3:DeleteObjectVersion'
                  - 's3:GetObjectVersion'
                  - 's3:GetObjectACL'
                  - 's3:PutObjectACL'
                Resource: !Join
                  - ''
                  - -  'arn:aws:s3:::'
                    -  !Ref SftpBucket
                    -  '/*'
  SshUser:
    Type: AWS::Transfer::User
    Properties: 
      HomeDirectory: !Sub '/${SftpBucket}/${UserName}'
      Role: !GetAtt SftpBucketRole.Arn
      ServerId: !Ref ServerId
      SshPublicKeys: 
        - !Ref SshPublicKey
      Tags: 
        - Key: BusinessOwnerContact
          Value: !Ref BusinessOwnerContact
        - Key: ContactEmail
          Value: !Ref RemoteOrganizationContact
      UserName: !Ref UserName

